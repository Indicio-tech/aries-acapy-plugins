services:
  # Credo Holder/Verifier - Long-running for development
  credo-agent:
    build:
      context: ./credo
    ports:
      - "3020:3020"
    environment:
      - NODE_ENV=development
      - PORT=3020
      - ACAPY_ISSUER_URL=http://acapy-issuer:8022
      - ACAPY_VERIFIER_URL=http://acapy-verifier:8032
    depends_on:
      acapy-issuer:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3020/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 45s
    restart: unless-stopped

  # ACA-Py Issuer - Development mode
  acapy-issuer:
    build: 
      dockerfile: docker/Dockerfile
      context: ../
    ports:
      - "8020:8020"  # inbound transport
      - "8021:8021"  # admin
      - "8022:8022"  # oid4vci endpoint
    environment:
      - AGENT_ENDPOINT=http://acapy-issuer:8020
      - OID4VCI_ENDPOINT=http://acapy-issuer:8022
      - WALLET_STORAGE_TYPE=${WALLET_STORAGE_TYPE:-sqlite}
      - PYTHONPATH=/usr/src/app/isomdl_wrapper:/usr/src/app
      - LOG_LEVEL=DEBUG
    command: ["aca-py", "start", "--arg-file", "/usr/src/app/docker/dev.yml", "--wallet-storage-type", "${WALLET_STORAGE_TYPE:-sqlite}", "--log-level", "DEBUG"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8021/status/ready"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 45s
    restart: unless-stopped

  # ACA-Py Verifier - Development mode
  acapy-verifier:
    build: 
      dockerfile: docker/Dockerfile
      context: ../
    ports:
      - "8030:8030"  # inbound transport
      - "8031:8031"  # admin
      - "8032:8032"  # oid4vp endpoint
      - "8033:8033"  # oid4vci endpoint
    environment:
      - AGENT_ENDPOINT=http://acapy-verifier:8030
      - OID4VCI_ENDPOINT=http://acapy-verifier:8033
      - OID4VP_ENDPOINT=http://acapy-verifier:8032
      - WALLET_STORAGE_TYPE=${WALLET_STORAGE_TYPE:-sqlite}
      - PYTHONPATH=/usr/src/app/isomdl_wrapper:/usr/src/app
      - LOG_LEVEL=DEBUG
    command: ["aca-py", "start", "--arg-file", "/usr/src/app/docker/dev-verifier.yml", "--wallet-storage-type", "${WALLET_STORAGE_TYPE:-sqlite}", "--log-level", "DEBUG"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8031/status/ready"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 45s
    restart: unless-stopped

  # Interactive Test Environment - No auto-run, for manual testing
  test-river:
    build:
      context: .
      dockerfile: Dockerfile.test.runner
    working_dir: /usr/src/app
    environment:
      - CREDO_AGENT_URL=http://credo-agent:3020
      - ACAPY_ISSUER_ADMIN_URL=http://acapy-issuer:8021
      - ACAPY_ISSUER_OID4VCI_URL=http://acapy-issuer:8022
      - ACAPY_VERIFIER_ADMIN_URL=http://acapy-verifier:8031
      - ACAPY_VERIFIER_OID4VP_URL=http://acapy-verifier:8032
      - PYTHONPATH=/usr/src/app
    volumes:
      - ./test-results:/usr/src/app/test-results
      - .:/usr/src/app/src  # Mount source for live editing
    depends_on:
      credo-agent:
        condition: service_healthy
      acapy-issuer:
        condition: service_healthy
      acapy-verifier:
        condition: service_healthy
    # Keep container running for interactive use
    command: ["tail", "-f", "/dev/null"]
    tty: true
    stdin_open: true

volumes:
  test-results: