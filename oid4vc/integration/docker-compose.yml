services:
  # Credo Holder/Verifier - Receives credentials from ACA-Py
  credo-agent:
    build:
      context: ./credo
    ports:
      - "3020:3020"
    environment:
      - NODE_ENV=development
      - PORT=3020
      - ACAPY_ISSUER_URL=http://acapy-issuer.local:8022
      - ACAPY_VERIFIER_URL=http://acapy-verifier.local:8032
      - TRUST_ANCHORS_PATH=/etc/credo/certs/trust-anchors
    volumes:
      - ./certs/trust-anchors:/etc/credo/certs/trust-anchors:ro
    depends_on:
      acapy-issuer:
        condition: service_healthy
    restart: unless-stopped

  # Sphereon Wrapper - Receives credentials from ACA-Py
  sphereon-wrapper:
    build:
      context: ./sphereon
    ports:
      - "3010:3010"
    environment:
      - PORT=3010

  # ACA-Py Issuer - Issues credentials via OID4VCI
  acapy-issuer:
    build: 
      dockerfile: oid4vc/docker/Dockerfile
      context: ../../
      args:
        ACAPY_VERSION: 1.4.0
    ports:
      - "8020:8020"  # inbound transport
      - "8083:8021"  # admin (mapped to 8083)
      - "8022:8022"  # oid4vci endpoint
    environment:
      - AGENT_ENDPOINT=http://acapy-issuer:8020
      - OID4VCI_ENDPOINT=http://acapy-issuer.local:8022
      - STATUS_LIST_PUBLIC_URI=http://acapy-issuer.local:8022/status/{list_number}
      - WALLET_STORAGE_TYPE=${WALLET_STORAGE_TYPE:-sqlite}
      - PYTHONPATH=/usr/src/app/isomdl_wrapper:/usr/src/app
      - ACAPY_ADMIN_PORT=8021
      - LOG_LEVEL=DEBUG
      - OID4VC_MDOC_SIGNING_KEY_PATH=/etc/acapy/mdoc/certs/leaf.key
      - OID4VC_MDOC_SIGNING_CERT_PATH=/etc/acapy/mdoc/certs/leaf.pem
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8021/status/ready"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 300s
    volumes:
      - ../docker/dev.yml:/usr/src/app/docker/dev.yml
      - ../oid4vc:/usr/src/app/oid4vc
      - ../mso_mdoc:/usr/src/app/mso_mdoc
      - ./certs:/etc/acapy/mdoc/certs/
    networks:
      default:
        aliases:
          - acapy-issuer.local
    command: aca-py start --arg-file /usr/src/app/docker/dev.yml --wallet-storage-type ${WALLET_STORAGE_TYPE:-sqlite} --log-level DEBUG
    restart: unless-stopped

  # ACA-Py Verifier - Receives presentations from Credo
  acapy-verifier:
    build: 
      dockerfile: oid4vc/docker/Dockerfile
      context: ../../
      args:
        ACAPY_VERSION: 1.4.0
    ports:
      - "8030:8030"  # inbound transport
      - "8031:8031"  # admin
      - "8032:8032"  # oid4vp endpoint
      - "8033:8033"  # oid4vci endpoint
    environment:
      - AGENT_ENDPOINT=http://acapy-verifier:8030
      - OID4VCI_ENDPOINT=http://acapy-verifier.local:8033
      - OID4VP_ENDPOINT=http://acapy-verifier.local:8032
      - WALLET_STORAGE_TYPE=${WALLET_STORAGE_TYPE:-sqlite}
      - PYTHONPATH=/usr/src/app/isomdl_wrapper:/usr/src/app
      - ACAPY_ADMIN_PORT=8031
      - LOG_LEVEL=DEBUG
      - OID4VC_MDOC_TRUST_ANCHORS_PATH=/etc/acapy/mdoc/trust-anchors/
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8031/status/ready"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 300s
    volumes:
      - ../../oid4vc/oid4vc:/usr/src/app/oid4vc
      - ../../oid4vc/mso_mdoc:/usr/src/app/mso_mdoc
      - ../docker/dev-verifier.yml:/usr/src/app/docker/dev-verifier.yml
      - ./certs/trust-anchors:/etc/acapy/mdoc/trust-anchors/
    networks:
      default:
        aliases:
          - acapy-verifier.local
    command: aca-py start --arg-file /usr/src/app/docker/dev-verifier.yml --wallet-storage-type ${WALLET_STORAGE_TYPE:-sqlite} --log-level DEBUG
    restart: unless-stopped

  # Integration Test Runner
  test-river:
    build:
      context: .
      dockerfile: Dockerfile.test.runner
      args:
        ACAPY_VERSION: 1.4.0
    working_dir: /usr/src/app
    environment:
      - REQUIRE_MDOC=true
      - CREDO_AGENT_URL=http://credo-agent:3020
      - SPHEREON_WRAPPER_URL=http://sphereon-wrapper:3010
      - ACAPY_ISSUER_ADMIN_URL=http://acapy-issuer:8021
      - ACAPY_ISSUER_OID4VCI_URL=http://acapy-issuer.local:8022
      - ACAPY_VERIFIER_ADMIN_URL=http://acapy-verifier:8031
      - ACAPY_VERIFIER_OID4VP_URL=http://acapy-verifier.local:8032
      - PYTHONPATH=/usr/src/app
      - WAIT_HOSTS=credo-agent:3020,sphereon-wrapper:3010,acapy-issuer:8021,acapy-verifier:8031
      - WAIT_HOSTS_TIMEOUT=300
    volumes:
      - ./test-results:/usr/src/app/test-results
      - ./tests:/usr/src/app/tests
      - ./certs:/usr/src/app/certs
    depends_on:
      credo-agent:
        condition: service_healthy
      sphereon-wrapper:
        condition: service_healthy
      acapy-issuer:
        condition: service_healthy
      acapy-verifier:
        condition: service_healthy
    command: >
      /bin/sh -c "
      /wait &&
      uv run pytest tests/ --verbose --tb=short --junit-xml=test-results/junit-quick.xml --durations=5
      "

volumes:
  test-results:
        
