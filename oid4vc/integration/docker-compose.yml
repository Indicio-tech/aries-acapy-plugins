services:
  # Credo Holder/Verifier - Receives credentials from ACA-Py
  credo-agent:
    build:
      context: ./credo
    ports:
      - "3020:3020"
    environment:
      - NODE_ENV=development
      - PORT=3020
      - ACAPY_ISSUER_URL=http://acapy-issuer.local:8022
      - ACAPY_VERIFIER_URL=http://acapy-verifier.local:8032
    depends_on:
      acapy-issuer:
        condition: service_healthy

  # Sphereon Wrapper - Receives credentials from ACA-Py
  sphereon-wrapper:
    build:
      context: ./sphereon
    ports:
      - "3010:3010"
    environment:
      - PORT=3010

  # ACA-Py Issuer - Issues credentials via OID4VCI
  acapy-issuer:
    build: 
      dockerfile: docker/Dockerfile
      context: ../
    ports:
      - "8020:8020"  # inbound transport
      - "8021:8021"  # admin
      - "8022:8022"  # oid4vci endpoint
    environment:
      - AGENT_ENDPOINT=http://acapy-issuer:8020
      - OID4VCI_ENDPOINT=http://acapy-issuer.local:8022
      - WALLET_STORAGE_TYPE=${WALLET_STORAGE_TYPE:-sqlite}
      - PYTHONPATH=/usr/src/app/isomdl_wrapper:/usr/src/app
      - ACAPY_ADMIN_PORT=8021
    networks:
      default:
        aliases:
          - acapy-issuer.local
    command: ["aca-py", "start", "--arg-file", "/usr/src/app/docker/dev.yml", "--wallet-storage-type", "${WALLET_STORAGE_TYPE:-sqlite}"]

  # ACA-Py Verifier - Receives presentations from Credo
  acapy-verifier:
    build: 
      dockerfile: docker/Dockerfile
      context: ../
    ports:
      - "8030:8030"  # inbound transport
      - "8031:8031"  # admin
      - "8032:8032"  # oid4vp endpoint
      - "8033:8033"  # oid4vci endpoint
    environment:
      - AGENT_ENDPOINT=http://acapy-verifier:8030
      - OID4VCI_ENDPOINT=http://acapy-verifier.local:8033
      - OID4VP_ENDPOINT=http://acapy-verifier.local:8032
      - WALLET_STORAGE_TYPE=${WALLET_STORAGE_TYPE:-sqlite}
      - PYTHONPATH=/usr/src/app/isomdl_wrapper:/usr/src/app
      - ACAPY_ADMIN_PORT=8031
    volumes:
      - ../oid4vc:/usr/src/app/oid4vc
    networks:
      default:
        aliases:
          - acapy-verifier.local
    command: ["aca-py", "start", "--arg-file", "/usr/src/app/docker/dev-verifier.yml", "--wallet-storage-type", "${WALLET_STORAGE_TYPE:-sqlite}"]

  # Integration Test Runner
  test-river:
    build:
      context: .
      dockerfile: Dockerfile.test.runner
    working_dir: /usr/src/app
    environment:
      - CREDO_AGENT_URL=http://credo-agent:3020
      - SPHEREON_WRAPPER_URL=http://sphereon-wrapper:3010
      - ACAPY_ISSUER_ADMIN_URL=http://acapy-issuer:8021
      - ACAPY_ISSUER_OID4VCI_URL=http://acapy-issuer.local:8022
      - ACAPY_VERIFIER_ADMIN_URL=http://acapy-verifier:8031
      - ACAPY_VERIFIER_OID4VP_URL=http://acapy-verifier.local:8032
      - PYTHONPATH=/usr/src/app
      - WAIT_HOSTS=credo-agent:3020,sphereon-wrapper:3010,acapy-issuer:8021,acapy-verifier:8031
      - WAIT_HOSTS_TIMEOUT=300
      - WAIT_SLEEP_INTERVAL=5
      - WAIT_HTTP_RETRY_COUNT=15
    volumes:
      - ./test-results:/usr/src/app/test-results
      - ./tests:/usr/src/app/tests
    depends_on:
      credo-agent:
        condition: service_healthy
      sphereon-wrapper:
        condition: service_healthy
      acapy-issuer:
        condition: service_healthy
      acapy-verifier:
        condition: service_healthy
    command: [
      "sh", "-c",
      "echo 'Running essential OID4VC integration tests...' && \
       uv run pytest tests/ \
       --verbose \
       --tb=short \
       --junit-xml=test-results/junit-quick.xml \
       --durations=5"
    ]

volumes:
  test-results:
        
