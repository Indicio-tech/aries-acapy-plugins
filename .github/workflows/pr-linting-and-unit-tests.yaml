name: Linting and Unit Tests
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - "**"
  push:
    branches:
      - main
  merge_group:

jobs:
  linting-and-unit-tests:
    name: "Code quality and unit tests"
    runs-on: ubuntu-latest
    outputs:
      changed-plugins: ${{ steps.changed-plugins.outputs.cache-hit }}
    steps:
      #----------------------------------------------
      #       Check out repo
      #----------------------------------------------
      - name: Check out repository
        uses: actions/checkout@v6
      #----------------------------------------------
      #       Install python and poetry with cache
      #----------------------------------------------
      - name: Install poetry
        run: pipx install poetry==2.1.2
        id: setup-poetry
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "poetry"
      #----------------------------------------------
      #       Get changed files
      #----------------------------------------------
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47.0.0
      #----------------------------------------------
      #       Get changed plugins
      #----------------------------------------------
      - name: Get changed plugins
        id: changed-plugins
        run: |

          # Collects all the plugin names that have changes.
          # If there is directory that isn't a plugin then it will need to skip it. Currently skipping plugin_globals
          declare -a changed_dirs=()
          for dir in ./*/; do
            current_folder=$(basename "$dir")
            if [[ $current_folder == "plugin_globals" ]]; then
              continue
            fi
            for changed_file in ${{ steps.changed-files.outputs.all_changed_files }}; do
              if [[ $changed_file == *"$current_folder"* ]]; then
                if ! [[ ${changed_dirs[*]} =~ $current_folder ]]; then
                  changed_dirs+=("$current_folder")
                fi
              fi
            done
          done

          echo "changed-plugins=${changed_dirs[*]}" >> $GITHUB_OUTPUT
      #----------------------------------------------
      #       Install Rust toolchain (for isomdl-uniffi)
      #----------------------------------------------
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
      #----------------------------------------------
      #       Install uniffi-bindgen (for isomdl-uniffi)
      #----------------------------------------------
      - name: Install uniffi-bindgen
        run: cargo install uniffi-bindgen --version 0.28.3
      #----------------------------------------------
      #       Install dependencies
      #----------------------------------------------
      - name: Install dependencies
        id: install-dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: |
          for dir in ${{ steps.changed-plugins.outputs.changed-plugins }}; do
            cd $dir
            poetry install --no-interaction --no-root --all-extras
            cd ..
          done
      #----------------------------------------------
      #       Lint plugins
      #----------------------------------------------
      - name: Lint plugins
        id: lint-plugins
        run: |
          for dir in ${{ steps.changed-plugins.outputs.changed-plugins }}; do
            cd $dir
            poetry run ruff check .
            poetry run ruff format --check .
            cd ..
          done
      #----------------------------------------------
      #       Unit tests
      #----------------------------------------------
      - name: Unit test plugins
        id: unit-tests
        run: |
          for dir in ${{ steps.changed-plugins.outputs.changed-plugins }}; do
            cd $dir
            poetry run pytest
            cd ..
          done
  integration-tests:
    name: "Integration tests"
    runs-on: ubuntu-latest
    needs: linting-and-unit-tests
    if: needs.linting-and-unit-tests.result == 'success'
    steps:
      #----------------------------------------------
      #       Check out repo
      #----------------------------------------------
      - name: Check out repository
        uses: actions/checkout@v6
      #----------------------------------------------
      #       Get changed files
      #----------------------------------------------
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47.0.0
      #----------------------------------------------
      #       Get changed plugins
      #----------------------------------------------
      - name: Get changed plugins
        id: changed-plugins
        run: |
          # Collects all the plugin names that have changes
          declare -a changed_dirs=()
          for dir in ./*/; do
            current_folder=$(basename "$dir")
            if [[ $current_folder == "plugin_globals" ]]; then
              continue
            fi
            for changed_file in ${{ steps.changed-files.outputs.all_changed_files }}; do
              if [[ $changed_file == *"$current_folder"* ]]; then
                if ! [[ ${changed_dirs[*]} =~ $current_folder ]]; then
                  changed_dirs+=("$current_folder")
                fi
              fi
            done
          done

          echo "changed-plugins=${changed_dirs[*]}" >> $GITHUB_OUTPUT
      #----------------------------------------------
      #       Initialize Docker Compose
      #----------------------------------------------
      - name: Initialize Docker Compose
        uses: isbang/compose-action@v1.5.1
      #----------------------------------------------
      #       Run Integration Tests
      #----------------------------------------------
      - name: Run Integration Tests
        id: integration-tests
        shell: bash
        run: |
          for dir in ${{ steps.changed-plugins.outputs.changed-plugins }}; do
            # Check if integration directory exists
            if [[ ! -d "$dir/integration" ]]; then
              echo "‚è≠Ô∏è  Skipping integration tests for $dir (no integration directory)"
              continue
            fi

            echo "üîß Running integration tests for $dir"
            cd "$dir/integration"

            # Source init-network.sh if it exists
            if [ -f ./init-network.sh ]; then
              echo "üì° Sourcing init-network.sh"
              . ./init-network.sh
            fi

            docker compose build test-river

            # Run tests
            if ! docker compose up --exit-code-from test-river test-river; then
              echo "‚ùå Tests failed for $dir - dumping logs:"
              docker compose logs test-river
              docker compose down --remove-orphans
              exit 1
            fi

            echo "‚úÖ Tests passed for $dir"
            docker compose down --remove-orphans
            cd ../..
          done